<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krok Admin - Master Database</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f9; max-width: 900px; margin: 0 auto; color: #333; }
        h1, h2 { color: #0057b8; margin-top: 0; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* Form Elements */
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 0.9em; color: #555; }
        input[type="text"], input[type="password"], input[type="file"] { 
            padding: 10px; width: 100%; box-sizing: border-box; margin-top: 5px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        
        /* Buttons */
        .btn { padding: 12px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: #0057b8; }
        .btn-primary:hover { background: #004494; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #eee; position: sticky; top: 0; }
        tr:hover { background-color: #f9f9f9; }
        
        /* Status Bar */
        .status-bar { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; justify-content: space-between; font-size: 0.9em; border-left: 5px solid #0057b8; }
        .status-item strong { color: #0057b8; }

        /* Loading Overlay */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 1000; text-align: center; padding-top: 200px; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #0057b8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner"></div>
        <h2 id="overlay-text">Connecting...</h2>
    </div>

    <h1>üîß Krok Command Center</h1>

    <!-- 1. AUTHENTICATION -->
    <div class="card" id="auth-card">
        <h2>üîê 1. Connect to GitHub</h2>
        <label>GitHub Token:</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
        
        <div style="display: flex; gap: 15px;">
            <div style="flex:1">
                <label>Username:</label>
                <input type="text" id="gh-owner" value="MidoN37">
            </div>
            <div style="flex:1">
                <label>Repository:</label>
                <input type="text" id="gh-repo" value="daily-scraper-krok">
            </div>
        </div>
        <br>
        <button class="btn btn-primary" onclick="loadDashboard()">Connect</button>
    </div>

    <div id="dashboard" style="display:none;">
        
        <!-- SYSTEM STATUS -->
        <div class="status-bar">
            <div class="status-item">Status: <strong>Connected</strong></div>
            <div class="status-item">Active Folder: <strong><span id="status-folder">Merged/TXT</span></strong></div>
            <div class="status-item">Last Updated: <strong><span id="status-date">...</span></strong></div>
        </div>

        <!-- 2. MANAGE FILES -->
        <div class="card">
            <h2>üìã Master Database (Merged)</h2>
            <p>Edit passwords below and click <b>Save</b>.</p>
            
            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #eee;">
                <table>
                    <thead>
                        <tr>
                            <th width="40">On</th>
                            <th>File Name</th>
                            <th width="150">Password</th>
                            <th width="80">Action</th>
                        </tr>
                    </thead>
                    <tbody id="file-table-body"></tbody>
                </table>
            </div>
            <br>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveConfigOnly()">üíæ Save Changes</button>
        </div>

        <!-- 3. UPLOAD -->
        <div class="card" style="border-left: 5px solid #28a745;">
            <h3 style="margin-top:0;">üì§ Manual Upload</h3>
            <p>Uploads will be added to the <b>Master Database</b>.</p>
            <div style="display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 2;">
                    <label>File:</label>
                    <input type="file" id="new-file-input" accept=".txt">
                </div>
                <div style="flex: 1;">
                    <label>Password:</label>
                    <input type="text" id="new-file-pass" placeholder="12345">
                </div>
                <div style="flex: 0 0 auto; padding-bottom: 15px;">
                    <button class="btn btn-success" onclick="uploadAndRegister()">Upload</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- STATE ---
    let currentConfigSha = ""; 
    let existingConfig = { files: [], passwords: {}, active_folder: "", last_updated: "" };
    
    // Auto-fill
    if(localStorage.getItem('krok_gh_owner')) document.getElementById('gh-owner').value = localStorage.getItem('krok_gh_owner');
    if(localStorage.getItem('krok_gh_repo')) document.getElementById('gh-repo').value = localStorage.getItem('krok_gh_repo');

    // --- HELPERS ---
    const getAuth = () => ({
        token: document.getElementById('gh-token').value,
        owner: document.getElementById('gh-owner').value,
        repo: document.getElementById('gh-repo').value
    });

    const showLoading = (msg) => {
        document.getElementById('overlay-text').innerText = msg;
        document.getElementById('overlay').style.display = 'block';
    };

    const hideLoading = () => { document.getElementById('overlay').style.display = 'none'; };
    function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }

    // --- LOGIC ---

    async function loadDashboard() {
        const { token, owner, repo } = getAuth();
        if(!token) return alert("Please enter Token");

        localStorage.setItem('krok_gh_owner', owner);
        localStorage.setItem('krok_gh_repo', repo);

        showLoading("Fetching config...");

        try {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/config.json?t=${Date.now()}`;
            const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
            
            if(res.ok) {
                const data = await res.json();
                currentConfigSha = data.sha;
                const content = atob(data.content);
                const jsonString = decodeURIComponent(Array.prototype.map.call(content, function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                existingConfig = JSON.parse(jsonString);
            } else {
                alert("Config file not found!");
                hideLoading();
                return;
            }

            // Update UI
            document.getElementById('status-folder').innerText = existingConfig.active_folder || "Merged/TXT";
            document.getElementById('status-date').innerText = existingConfig.last_updated || "N/A";

            renderTable();
            document.getElementById('auth-card').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            hideLoading();
        }
    }

    function renderTable() {
        const tbody = document.getElementById('file-table-body');
        tbody.innerHTML = '';

        // Safely access the files array (it's a flat list now)
        const files = existingConfig.files || [];

        if (files.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">No files found.</td></tr>';
            return;
        }

        files.forEach(filename => {
            const tr = document.createElement('tr');
            const pass = (existingConfig.passwords && existingConfig.passwords[filename]) ? existingConfig.passwords[filename] : "";

            tr.innerHTML = `
                <td style="text-align:center;"><input type="checkbox" checked class="file-active-cb" data-fname="${filename}"></td>
                <td>${filename}</td>
                <td><input type="text" value="${pass}" class="file-pass-input" data-fname="${filename}" style="margin:0;"></td>
                <td><button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" onclick="removeRow(this)">Remove</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function removeRow(btn) {
        if(confirm("Remove this file from the list?")) btn.closest('tr').remove();
    }

    async function saveConfigOnly() {
        showLoading("Saving...");
        
        const currentFiles = [];
        const passwordMap = existingConfig.passwords || {};

        document.querySelectorAll('#file-table-body tr').forEach(tr => {
            const cb = tr.querySelector('.file-active-cb');
            if (cb) {
                const inp = tr.querySelector('.file-pass-input');
                const fname = cb.dataset.fname;
                
                if(inp) passwordMap[fname] = inp.value; // Update Password
                if(cb.checked) currentFiles.push(fname); // Keep file if checked
            }
        });

        existingConfig.files = currentFiles;
        existingConfig.passwords = passwordMap;

        await pushToGitHub();
    }

    async function uploadAndRegister() {
        const fileInput = document.getElementById('new-file-input');
        const passInput = document.getElementById('new-file-pass');
        const file = fileInput.files[0];

        if(!file) return alert("Select a file.");
        const { token, owner, repo } = getAuth();
        
        // Always upload to the active folder (Merged/TXT)
        let targetFolder = existingConfig.active_folder || "Merged/TXT";
        targetFolder = targetFolder.replace(/^\/|\/$/g, '');
        
        const reader = new FileReader();
        reader.readAsText(file); 

        reader.onload = async function() {
            showLoading(`Uploading ${file.name}...`);
            try {
                // 1. Upload File
                const contentBase64 = utf8_to_b64(reader.result);
                const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(targetFolder + '/' + file.name)}`;
                
                // Get SHA if exists
                const checkRes = await fetch(uploadUrl, { headers: { Authorization: `token ${token}` } });
                let sha = null;
                if(checkRes.ok) sha = (await checkRes.json()).sha;

                const payload = { message: "Upload via Admin", content: contentBase64 };
                if(sha) payload.sha = sha;

                const putRes = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(!putRes.ok) throw new Error("Upload failed");

                // 2. Update Config Local State
                if (!existingConfig.files.includes(file.name)) existingConfig.files.push(file.name);
                existingConfig.passwords[file.name] = passInput.value || "12345";

                // 3. Save Config
                await pushToGitHub();
                
                alert("Saved!");
                fileInput.value = "";
                passInput.value = "";
                renderTable();

            } catch (e) {
                alert("Error: " + e.message);
                hideLoading();
            }
        };
    }

    async function pushToGitHub() {
        const { token, owner, repo } = getAuth();
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/config.json`;
        const jsonStr = JSON.stringify(existingConfig, null, 2);
        
        const payload = {
            message: "Update config (Admin)",
            content: utf8_to_b64(jsonStr),
            sha: currentConfigSha
        };

        const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(!res.ok) throw new Error("Failed to save config.json");
        
        const data = await res.json();
        currentConfigSha = data.content.sha;
        hideLoading();
        alert("Changes Saved Successfully!");
    }
</script>

</body>
</html>
