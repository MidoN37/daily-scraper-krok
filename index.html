<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krok Testing System</title>
    <style>
        :root { --primary: #0057b8; --secondary: #ffd700; --bg: #f4f4f9; --text: #333; --success: #28a745; --error: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--primary); }
        .screen { display: none; }
        .screen.active { display: block; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #004494; }
        .btn-secondary { background: #6c757d; }
        .btn-large { display: block; width: 100%; margin: 10px 0; padding: 15px; font-size: 18px; }
        .list-item { background: #eee; margin: 5px 0; padding: 15px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .list-item:hover { background: #ddd; }
        .list-item span:first-child { font-weight: bold; }
        .option-label { display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 5px; cursor: pointer; }
        .option-label:hover { background: #f0f8ff; }
        .correct-answer { background-color: #d4edda !important; }
        .wrong-answer { background-color: #f8d7da !important; }
        .nav-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 20px; justify-content: center; }
        .nav-item { width: 35px; height: 35px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .nav-item.current { border: 2px solid var(--primary); font-weight: bold; }
        .nav-item.answered { background: #e2e6ea; }
        .nav-item.flagged-correct { background: var(--success); color: white; }
        .nav-item.flagged-wrong { background: var(--error); color: white; }
        .result-card { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ccc; }
        .result-card.correct { border-left-color: var(--success); }
        .result-card.wrong { border-left-color: var(--error); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <!-- LOADING -->
    <div id="screen-loading" class="screen active">
        <h1>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏...</h1>
        <div class="loader"></div>
    </div>

    <!-- SELECT FILE -->
    <div id="screen-select-file" class="screen">
        <h1>–û–±–µ—Ä—ñ—Ç—å –±–∞–∑—É —Ç–µ—Å—Ç—ñ–≤</h1>
        <p id="db-info" style="text-align: center; color: #666; margin-bottom: 20px; font-weight: bold;"></p>
        <ul id="file-list" style="list-style: none; padding: 0;"></ul>
    </div>

    <!-- PASSWORD -->
    <div id="screen-password" class="screen" style="text-align: center;">
        <h2>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å</h2>
        <p id="password-msg"></p>
        <input type="password" id="password-input" style="padding: 10px; font-size: 16px;">
        <br><br>
        <button class="btn" onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- MODE -->
    <div id="screen-mode" class="screen" style="text-align: center;">
        <h2>–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º</h2>
        <button class="btn btn-large" onclick="setMode('krok')">üéì –†–µ–∂–∏–º –ö–†–û–ö</button>
        <button class="btn btn-large" style="background-color: var(--success);" onclick="setMode('practice')">‚úÖ –¢—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º</button>
        <br>
        <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- PARTS -->
    <div id="screen-parts" class="screen">
        <h1>–û–±–µ—Ä—ñ—Ç—å —á–∞—Å—Ç–∏–Ω—É</h1>
        <p style="text-align: center;">(50 –ø–∏—Ç–∞–Ω—å —É –±–ª–æ—Ü—ñ)</p>
        <ul id="parts-list" style="list-style: none; padding: 0;"></ul>
        <button class="btn btn-secondary" onclick="showScreen('screen-mode')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- QUIZ -->
    <div id="screen-quiz" class="screen">
        <div style="display: flex; justify-content: space-between;">
            <span id="quiz-progress"></span>
            <span id="quiz-mode-label" style="font-weight: bold; color: var(--primary);"></span>
        </div>
        <div id="q-text" style="font-size: 1.2em; font-weight: bold; margin: 20px 0;"></div>
        <div id="q-options"></div>
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button class="btn btn-secondary" onclick="prevQuestion()">Prev</button>
            <button class="btn" onclick="nextQuestion()">Next</button>
        </div>
        <div class="nav-grid" id="nav-grid"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" style="background: var(--error);" onclick="finishQuiz()">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="screen-results" class="screen">
        <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h1>
        <h2 id="score-display"></h2>
        <div id="detailed-results"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="showScreen('screen-parts')">–ß–∞—Å—Ç–∏–Ω–∏</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–°–ø–∏—Å–æ–∫</button>
        </div>
    </div>
</div>

<script>
    let QUIZ_FILES = [];
    let FILE_PASSWORDS = {};
    let ACTIVE_FOLDER = "";
    const DEFAULT_PASS = "1234";

    let loadedFiles = {};
    let selectedFilename = "";
    let selectedMode = "";
    let currentQuizQuestions = [];
    let userAnswers = {};
    let currentQIndex = 0;

    window.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        try {
            const res = await fetch('./config.json?t=' + Date.now());
            if(!res.ok) throw new Error("Config not found");
            const conf = await res.json();

            // Setup Globals
            QUIZ_FILES = conf.files || [];
            FILE_PASSWORDS = conf.passwords || {};
            ACTIVE_FOLDER = conf.active_folder || "";
            if(ACTIVE_FOLDER && !ACTIVE_FOLDER.endsWith('/')) ACTIVE_FOLDER += '/';

            // UI Info
            const dateStr = conf.last_updated || "N/A";
            document.getElementById('db-info').innerText = `–ë–∞–∑–∞: ${dateStr}`;

            if(QUIZ_FILES.length === 0) {
                alert("No files found in config.");
                showScreen('screen-select-file');
                return;
            }

            // Load Files
            let loadedCount = 0;
            const promises = QUIZ_FILES.map(async (fname) => {
                try {
                    const r = await fetch(ACTIVE_FOLDER + encodeURIComponent(fname));
                    if(r.ok) {
                        const txt = await r.text();
                        const qs = parseTXT(txt);
                        if(qs.length > 0) {
                            loadedFiles[fname] = qs;
                            loadedCount++;
                        }
                    }
                } catch(e) { console.error(e); }
            });

            await Promise.all(promises);
            renderFileList();
            showScreen('screen-select-file');

        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = "";
        Object.keys(loadedFiles).sort().forEach(fname => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<span>${fname}</span> <span>${loadedFiles[fname].length}</span>`;
            li.onclick = () => {
                selectedFilename = fname;
                document.getElementById('password-input').value = "";
                document.getElementById('password-msg').innerText = fname;
                showScreen('screen-password');
            };
            list.appendChild(li);
        });
    }

    function checkPassword() {
        const val = document.getElementById('password-input').value;
        const pass = FILE_PASSWORDS[selectedFilename] || DEFAULT_PASS;
        if(val.trim() === pass) showScreen('screen-mode');
        else alert("Wrong password");
    }

    function setMode(mode) {
        selectedMode = mode;
        const total = loadedFiles[selectedFilename].length;
        const parts = Math.ceil(total / 50);
        const ul = document.getElementById('parts-list');
        ul.innerHTML = "";
        for(let i=0; i<parts; i++) {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `–ß–∞—Å—Ç–∏–Ω–∞ ${i+1} (${i*50+1} - ${Math.min((i+1)*50, total)})`;
            li.onclick = () => startQuiz(i);
            ul.appendChild(li);
        }
        showScreen('screen-parts');
    }

    function startQuiz(part) {
        const all = loadedFiles[selectedFilename];
        const slice = all.slice(part*50, (part+1)*50);
        
        // Shuffle
        currentQuizQuestions = slice.map(q => {
            const idxs = q.opts.map((_,i)=>i);
            for(let i=idxs.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
            }
            return { 
                q: q.q, 
                opts: idxs.map(i => q.opts[i]), 
                correct: idxs.indexOf(q.correct) 
            };
        });
        
        for(let i=currentQuizQuestions.length-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [currentQuizQuestions[i], currentQuizQuestions[j]] = [currentQuizQuestions[j], currentQuizQuestions[i]];
        }

        userAnswers = {};
        currentQIndex = 0;
        document.getElementById('quiz-mode-label').innerText = selectedMode === 'krok' ? "KROK" : "Training";
        renderNav();
        loadQ(0);
        showScreen('screen-quiz');
    }

    function loadQ(idx) {
        if(idx<0 || idx>=currentQuizQuestions.length) return;
        currentQIndex = idx;
        const q = currentQuizQuestions[idx];
        document.getElementById('quiz-progress').innerText = `${idx+1} / ${currentQuizQuestions.length}`;
        document.getElementById('q-text').innerText = q.q;
        
        const div = document.getElementById('q-options');
        div.innerHTML = "";
        const ans = userAnswers[idx];

        q.opts.forEach((opt, i) => {
            const lbl = document.createElement('label');
            lbl.className = 'option-label';
            
            if(selectedMode === 'practice' && ans !== undefined) {
                if(i === q.correct) lbl.classList.add('correct-answer');
                if(ans === i && i !== q.correct) lbl.classList.add('wrong-answer');
                lbl.style.pointerEvents = 'none';
            }

            const inp = document.createElement('input');
            inp.type = 'radio';
            inp.name = 'opt';
            if(ans === i) inp.checked = true;
            inp.onchange = () => {
                if(selectedMode === 'practice' && userAnswers[idx] !== undefined) return;
                userAnswers[idx] = i;
                if(selectedMode === 'practice') loadQ(idx);
                renderNav();
            };
            lbl.append(inp, opt);
            div.appendChild(lbl);
        });
        renderNav();
    }

    function renderNav() {
        const div = document.getElementById('nav-grid');
        div.innerHTML = "";
        currentQuizQuestions.forEach((_, i) => {
            const box = document.createElement('div');
            box.className = `nav-item ${i===currentQIndex?'current':''} ${userAnswers[i]!==undefined?'answered':''}`;
            if(selectedMode === 'practice' && userAnswers[i]!==undefined) {
                box.className += (userAnswers[i]===currentQuizQuestions[i].correct ? ' flagged-correct' : ' flagged-wrong');
            }
            box.innerText = i+1;
            box.onclick = () => loadQ(i);
            div.appendChild(box);
        });
    }

    function nextQuestion() { loadQ(currentQIndex+1); }
    function prevQuestion() { loadQ(currentQIndex-1); }

    function finishQuiz() {
        if(!confirm("Finish?")) return;
        let score = 0;
        const div = document.getElementById('detailed-results');
        div.innerHTML = "";
        
        currentQuizQuestions.forEach((q, i) => {
            const ans = userAnswers[i];
            const ok = ans === q.correct;
            if(ok) score++;
            
            const card = document.createElement('div');
            card.className = `result-card ${ok?'correct':'wrong'}`;
            card.innerHTML = `<b>${i+1}. ${q.q}</b><br>
                <span style="color:${ok?'green':'red'}">Your: ${ans!==undefined?q.opts[ans]:'-'}</span><br>
                <span style="color:green">Correct: ${q.opts[q.correct]}</span>`;
            div.appendChild(card);
        });

        document.getElementById('score-display').innerText = `Score: ${score} / ${currentQuizQuestions.length}`;
        showScreen('screen-results');
    }

    function parseTXT(txt) {
        txt = txt.replace(/\r\n/g, '\n');
        const blocks = txt.split(/\n(?=\d+\.)/);
        const ret = [];
        blocks.forEach(b => {
            b = b.trim();
            if(!b) return;
            const lines = b.split('\n');
            let q = lines[0].replace(/^\d+\.\s*/, '').trim();
            let optStart = 1;
            for(let i=1; i<lines.length; i++) {
                if(/^\*?[a-eA-E]\./.test(lines[i].trim())) { optStart=i; break; }
                q += " " + lines[i].trim();
            }
            const opts = [];
            let corr = -1;
            for(let i=optStart; i<lines.length; i++) {
                let l = lines[i].trim();
                if(/^\*?[a-eA-E]\./.test(l)) {
                    if(l.startsWith('*')) corr = opts.length;
                    opts.push(l.replace(/^\*?[a-eA-E]\.\s*/, '').trim());
                }
            }
            if(q && opts.length && corr !== -1) ret.push({q, opts, correct: corr});
        });
        return ret;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>

</body>
</html>
